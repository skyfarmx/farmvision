{% extends 'header.html' %}
{% block body %}
{% load static %}
{% include 'menu.html' %}
{% include 'navbar.html' with picture=userss.picture|default:'images/default-user.png' %}

<div id="wrapper">
    <div class="main-content">
        <div class="row small-spacing">
            <div class="col-xl-8 offset-xl-2 col-12">
                <div class="box-content card white">
                    <div class="card-header">
                        <h4 class="box-title">
                            <i class="ico fa fa-plus-circle text-success mr-2"></i>
                            {% if projes %}Projeyi D√ºzenle{% else %}Yeni Proje Ekle{% endif %}
                        </h4>
                        <p class="text-muted">Tarƒ±m alanƒ±nƒ±z i√ßin yeni bir proje olu≈üturun</p>
                    </div>
                    
                    <div class="card-content">
                        {% if userss != None %}
                        <form action="{{ request.path|urlencode }}" method="post" enctype="multipart/form-data" class="project-form">
                            {% csrf_token %}
                            
                            <!-- Farm Information Section -->
                            <div class="form-section">
                                <h5 class="section-title">
                                    <i class="fa fa-farm text-success"></i>
                                    √áiftlik Bilgileri
                                </h5>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="farm-name" class="form-label">
                                                <i class="fa fa-home text-muted mr-1"></i>
                                                √áiftlik Adƒ±
                                            </label>
                                            <input type="text" 
                                                   id="farm-name"
                                                   name="Farm" 
                                                   class="form-control form-control-lg" 
                                                   placeholder="√ñrn: Ye≈üil Vadi √áiftliƒüi"
                                                   value="{% if projes != None %}{{projes.Farm}}{% endif %}"
                                                   required>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="field-name" class="form-label">
                                                <i class="fa fa-leaf text-muted mr-1"></i>
                                                Tarla/Alan Adƒ±
                                            </label>
                                            <input type="text" 
                                                   id="field-name"
                                                   name="Field" 
                                                   class="form-control form-control-lg" 
                                                   placeholder="√ñrn: Kuzey Bah√ßesi"
                                                   value="{% if projes != None %}{{projes.Field}}{% endif %}"
                                                   required>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Project Details Section -->
                            <div class="form-section">
                                <h5 class="section-title">
                                    <i class="fa fa-clipboard-list text-primary"></i>
                                    Proje Detaylarƒ±
                                </h5>
                                
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="form-group">
                                            <label for="project-title" class="form-label">
                                                <i class="fa fa-tag text-muted mr-1"></i>
                                                Proje Ba≈ülƒ±ƒüƒ±
                                            </label>
                                            <input type="text" 
                                                   id="project-title"
                                                   name="Title" 
                                                   class="form-control form-control-lg" 
                                                   placeholder="√ñrn: 2024 Elma Hasatƒ± Analizi"
                                                   value="{% if projes != None %}{{projes.Title}}{% endif %}"
                                                   required>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="project-state" class="form-label">
                                                <i class="fa fa-flag text-muted mr-1"></i>
                                                Durum
                                            </label>
                                            <select name="State" 
                                                    id="project-state" 
                                                    class="form-control form-control-lg">
                                                <option value="Planlama" {% if projes.State == "Planlama" %}selected{% endif %}>
                                                    üìã Planlama
                                                </option>
                                                <option value="Aktif" {% if projes.State == "Aktif" %}selected{% endif %}>
                                                    üü¢ Aktif
                                                </option>
                                                <option value="Tamamlandƒ±" {% if projes.State == "Tamamlandƒ±" %}selected{% endif %}>
                                                    ‚úÖ Tamamlandƒ±
                                                </option>
                                                <option value="Beklemede" {% if projes.State == "Beklemede" %}selected{% endif %}>
                                                    ‚è∏Ô∏è Beklemede
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Image Upload Section -->
                            <div class="form-section">
                                <h5 class="section-title">
                                    <i class="fa fa-camera text-info"></i>
                                    Proje G√∂rseli
                                </h5>
                                <div class="image-upload-container">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <!-- Accessible file upload -->
                                            <label for="exampleInputFile" class="upload-area" style="cursor:pointer;">
                                                <div class="upload-content">
                                                    <i class="fa fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                                    <h6 class="text-muted">G√∂rsel Y√ºklemek ƒ∞√ßin Tƒ±klayƒ±n</h6>
                                                    <p class="text-muted small">PNG, JPG, GIF formatlarƒ± desteklenmektedir</p>
                                                    <button type="button" class="btn btn-outline-primary btn-sm" tabindex="-1">
                                                        <i class="fa fa-plus mr-1"></i>
                                                        Dosya Se√ß
                                                    </button>
                                                </div>
                                            </label>
                                            <input id="exampleInputFile" 
                                                   style="display: none" 
                                                   type="file" 
                                                   name="picture" 
                                                   accept="image/*" 
                                                   onchange="loadFile(event)">
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <div class="image-preview">
                                                <div class="preview-container">
                                                    <img id="output" 
                                                         src="{% if projes and projes.picture %}
                                                                {% if projes.picture.url %}
                                                                    {{ projes.picture.url }}
                                                                {% else %}
                                                                    {% static projes.picture %}
                                                                {% endif %}
                                                              {% else %}
                                                                {% static 'images/default-project.png' %}
                                                              {% endif %}"
                                                         alt="Proje G√∂rseli"
                                                         class="preview-image">
                                                    <div class="preview-overlay">
                                                        <i class="fa fa-eye"></i>
                                                    </div>
                                                </div>
                                                <p class="text-center text-muted small mt-2">Proje √ñnizleme</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Hidden Fields -->
                            <input type="hidden" name="kat_user" value="{{userss.id}}">
                            {# Remove hashing_path if not used #}
                            <!-- <input type="hidden" id="hashing_path" name="hashing_path" value="0"> -->

                            <!-- Action Buttons -->
                            <div class="form-actions">
                                <div class="row">
                                    <div class="col-md-6">
                                        <a href="{% url 'projects_list' %}" class="btn btn-light btn-lg btn-block">
                                            <i class="fa fa-arrow-left mr-2"></i>
                                            Geri D√∂n
                                        </a>
                                    </div>
                                    <div class="col-md-6">
                                        <button type="submit" class="btn btn-success btn-lg btn-block">
                                            <i class="fa fa-save mr-2"></i>
                                            {% if projes %}G√ºncelle{% else %}Proje Olu≈ütur{% endif %}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="fa fa-exclamation-triangle mr-2"></i>
                            Bu sayfaya eri≈üim i√ßin giri≈ü yapmanƒ±z gerekmektedir.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* ...[your existing styles remain unchanged]... */
</style>

<script>
var loadFile = function(event) {
    if (!event.target.files.length) return;
    var reader = new FileReader();
    reader.onload = function(){
        var output = document.getElementById('output');
        output.src = reader.result;
        output.style.opacity = '0';
        setTimeout(function() {
            output.style.transition = 'opacity 0.3s ease';
            output.style.opacity = '1';
        }, 100);
    };
    reader.readAsDataURL(event.target.files[0]);
};

// Form validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('.project-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(function(field) {
                if (!field.value.trim()) {
                    field.style.borderColor = '#dc3545';
                    isValid = false;
                } else {
                    field.style.borderColor = '#28a745';
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                alert('L√ºtfen t√ºm zorunlu alanlarƒ± doldurun.');
            }
        });
        // Reset border color on input
        form.querySelectorAll('[required]').forEach(function(field) {
            field.addEventListener('input', function() {
                this.style.borderColor = '';
            });
        });
    }
});

// Auto-hide all alert types
setTimeout(function() {
    const alerts = document.querySelectorAll('.alert-success, .alert-info, .alert-warning');
    alerts.forEach(function(alert) {
        alert.style.transition = 'opacity 0.5s ease';
        alert.style.opacity = '0';
        setTimeout(function() {
            alert.remove();
        }, 500);
    });
}, 3000);
</script>

{% endblock %}
